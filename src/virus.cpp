#include "virus.h"

const SDL_Color COOLDOWN_COLOR={0,0,255},DAMAGE_COLOR={255,0,0},COOLDOWN_COUNTER_COLOR={0,0,255},NAME_COLOR={0,0,0};

void Virus::Load(char *filename,int _id)
{
 id=_id;
 FILE *in=fopen(filename,"r");
 fscanf(in,"%d %d %d %d ",&number_of_frames,&damage,&cooldown_time,&ram);
 char path_to_image[TEXT_LENGTH_MAX];
 fgets(path_to_image,sizeof path_to_image,in);
 int sq=strlen(path_to_image);
 if(path_to_image[sq-1]=='\n')
    path_to_image[sq-1]=NULL;
 char name[TEXT_LENGTH_MAX];
 fgets(name,sizeof name,in);
 sq=strlen(name);
 if(name[sq]=='\n')
    name[sq]=NULL;
 fclose(in);
 image=Load_Transparent_Texture(path_to_image);
 menu_image=Create_Transparent_Texture(image->w*2,image->h*2);
 Apply_Stretched_Texture(0,0,menu_image->w,menu_image->h,image,menu_image);
 Texture *cooldown_image,*damage_image,*name_image;
 char aux[TEXT_LENGTH_MAX],aux1[TEXT_LENGTH_MAX];
 name_image=Create_TTF_Texture(MENU_FONT_SMALL,name,NAME_COLOR);
 strcpy(aux1,"Cooldown: ");
 itoa(cooldown_time,aux);
 strcat(aux1,aux);
 cooldown_image=Create_TTF_Texture(MENU_FONT_SMALL,aux1,COOLDOWN_COLOR);
 strcpy(aux1,"Damage: ");
 itoa(damage,aux);
 strcat(aux1,aux);
 damage_image=Create_TTF_Texture(MENU_FONT_SMALL,aux1,DAMAGE_COLOR);
 menu_description=Create_Transparent_Texture(MENU_OPTION_BACKGROUND->w-2*PIXELS_PER_INGAME_UNIT,name_image->h+cooldown_image->h+damage_image->h+30);
 Apply_Texture((menu_description->w-name_image->w)/2,0,name_image,menu_description);
 Apply_Texture((menu_description->w-damage_image->w)/2,name_image->h+10,damage_image,menu_description);
 Apply_Texture((menu_description->w-cooldown_image->w)/2,name_image->h+damage_image->h+20,cooldown_image,menu_description);
 Destroy_Texture(cooldown_image);
 Destroy_Texture(damage_image);
 is_cool=true;
}

void Virus::Clear()
{
 damage=number_of_frames=cooldown_time=ram=0;
 current_frame=0;
 is_cool=true;
 cooldown_timer.stop();
 Destroy_Texture(image);
 Destroy_Texture(menu_image);
}

void Virus::Reset()
{
 is_cool=true;
}

void Virus::Print(int x,int y,Texture *_screen)
{
 Apply_Texture(current_frame*PIXELS_PER_INGAME_UNIT,0,x,y,PIXELS_PER_INGAME_UNIT,PIXELS_PER_INGAME_UNIT,image,_screen);
}

void Virus::Print_in_menu(int x,int y,Texture *_screen)
{
 Apply_Texture(x,y,MENU_OPTION_BACKGROUND,_screen);
 Apply_Texture(current_frame*2*PIXELS_PER_INGAME_UNIT,0,x+5,y+(MENU_OPTION_BACKGROUND->h-2*PIXELS_PER_INGAME_UNIT)/2,2*PIXELS_PER_INGAME_UNIT,2*PIXELS_PER_INGAME_UNIT,menu_image,_screen);
 Apply_Texture(x+5+2*PIXELS_PER_INGAME_UNIT+(MENU_OPTION_BACKGROUND->w-(x+5+2*PIXELS_PER_INGAME_UNIT)-menu_description->w)/2,y+(MENU_OPTION_BACKGROUND->h-menu_description->h-MENU_CONTROLLER_KEYS[id%4]->h)/2+5,menu_description,_screen);
 Apply_Texture(x+5+2*PIXELS_PER_INGAME_UNIT+(MENU_OPTION_BACKGROUND->w-(x+5+2*PIXELS_PER_INGAME_UNIT)-MENU_CONTROLLER_KEYS[id%4]->w)/2,y+MENU_OPTION_BACKGROUND->h-MENU_CONTROLLER_KEYS[id%4]->h,MENU_CONTROLLER_KEYS[id%4],_screen);
 if(!Is_cool())
    {
     Apply_Texture(x,y,MENU_OPTION_COOLING,_screen);
     char aux[TEXT_LENGTH_MAX];
     itoa(cooldown_time-cooldown_timer.get_ticks()/1000,aux);
     Texture *cooldown_counter=Create_TTF_Texture(MENU_FONT_BIG,aux,COOLDOWN_COUNTER_COLOR);
     Apply_Texture(x+(MENU_OPTION_BACKGROUND->w-cooldown_counter->w)/2,y+(MENU_OPTION_BACKGROUND->h-cooldown_counter->h)/2,cooldown_counter,_screen);
    }
}

void Virus::Update_frame()
{
 current_frame++;
 current_frame%=number_of_frames;
}

void Virus::Start_cooldown()
{
 is_cool=false;
 cooldown_timer.start();
}

bool Virus::Is_cool()
{
 if(!is_cool)
    is_cool=(cooldown_time*1000-cooldown_timer.get_ticks()<=0);
 return is_cool;
}

int Virus::Get_damage()
{
 return damage;
}

int Virus::Get_ram()
{
 return ram;
}

int Virus::Get_id()
{
 return id;
}
