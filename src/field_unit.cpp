#include "field_unit.h"
#include <typeinfo>
#include <type_traits>

const int angles[]={-90,0,90,180};
const int dirx[]={0,1,0,-1};
const int diry[]={1,0,-1,0};
const int ANIMATION_SMOOTHNESS=4,HP_HEIGHT=4;

void Field_unit::Print(int x,int y,Texture *_screen)
{
 if(map_x==0 || map_y==0 || map_x==ARENA_SIZE-1 || map_y==ARENA_SIZE-1 || Is_firewall())
    phase=ANIMATION_SMOOTHNESS;
 unit->Print(x+(map_y-diry[angle])*PIXELS_PER_INGAME_UNIT+diry[angle]*(PIXELS_PER_INGAME_UNIT/ANIMATION_SMOOTHNESS*phase),
             y+(map_x-dirx[angle])*PIXELS_PER_INGAME_UNIT+dirx[angle]*(PIXELS_PER_INGAME_UNIT/ANIMATION_SMOOTHNESS*phase),
             angles[angle],_screen);
 Apply_Stretched_Texture(x+(map_y-diry[angle])*PIXELS_PER_INGAME_UNIT+diry[angle]*(PIXELS_PER_INGAME_UNIT/ANIMATION_SMOOTHNESS*phase),
                         y+(map_x-dirx[angle])*PIXELS_PER_INGAME_UNIT+dirx[angle]*(PIXELS_PER_INGAME_UNIT/ANIMATION_SMOOTHNESS*phase),
                         PIXELS_PER_INGAME_UNIT*(unit->Get_health()-damage_taken)/unit->Get_health(),HP_HEIGHT,PLAYER_HP_IMAGE,_screen);
 Apply_Texture(x+(map_y-diry[angle])*PIXELS_PER_INGAME_UNIT+diry[angle]*(PIXELS_PER_INGAME_UNIT/ANIMATION_SMOOTHNESS*phase)+(PIXELS_PER_INGAME_UNIT-hp_image->w)/2,
              y+(map_x-dirx[angle])*PIXELS_PER_INGAME_UNIT+dirx[angle]*(PIXELS_PER_INGAME_UNIT/ANIMATION_SMOOTHNESS*phase),
              hp_image,_screen);
 Update_phase();
}

const int PHASE_CHANGE_DELAY=40;

void Field_unit::Update_phase()
{
 if(phase_timer.get_ticks()>PHASE_CHANGE_DELAY)
    {
     phase++;
     if(phase>ANIMATION_SMOOTHNESS)
        phase=ANIMATION_SMOOTHNESS;
     phase_timer.start();
    }
}

void Field_unit::Clear()
{
 Destroy_Texture(hp_image);
}

Field_unit::Field_unit()
{
 special_effect_timer.start();
}

void Field_unit::Set_map_pos(int x,int y)
{
 map_x=x;
 map_y=y;
 phase=0;
 phase_timer.start();
}

void Field_unit::Set_map_pos(std::pair<int,int> pos)
{
 Set_map_pos(pos.first,pos.second);
}

void Field_unit::Set_damage_taken(int _damage_taken)
{
 damage_taken=_damage_taken;
 char aux[TEXT_LENGTH_MAX]={NULL},aux1[TEXT_LENGTH_MAX]={NULL};
 itoa(unit->Get_health()-damage_taken,aux1);
 strcat(aux,aux1);
 strcat(aux," / ");
 itoa(unit->Get_health(),aux1);
 strcat(aux,aux1);
 Destroy_Texture(hp_image);
 hp_image=Create_TTF_Texture(MENU_FONT_SMALL,aux,PLAYER_HP_COLOR);
}

void Field_unit::Take_damage(int _damage)
{
 Set_damage_taken(damage_taken+_damage);
}

void Field_unit::Set_unit(Combat_unit *_unit)
{
 unit=_unit;
}

void Field_unit::Set_angle(int _angle)
{
 angle=_angle;
}

std::pair<int,int> Field_unit::Get_map_pos()
{
 return std::make_pair(map_x,map_y);
}

Combat_unit *Field_unit::Get_combat_unit()
{
 return unit;
}

int Field_unit::Get_phase()
{
 return phase;
}

bool Field_unit::Is_dead()
{
 return damage_taken>=unit->Get_health();
}

bool Field_unit::Phase_finished()
{
 return phase==ANIMATION_SMOOTHNESS;
}

bool Field_unit::Is_firewall()
{
 return (typeid(*unit)==typeid(Firewall) || typeid(*unit)==typeid(Firewall_plus) || typeid(*unit)==typeid(Antivirus_scanner) || typeid(*unit)==typeid(Security_service));
}

bool Field_unit::Is_virus()
{
 return !Is_firewall();
}

bool Field_unit::Triggered_special_effect()
{
 if(special_effect_timer.get_ticks()>unit->Get_attack_delay())
    {
     special_effect_timer.start();
     return true;
    }
 return false;
}
