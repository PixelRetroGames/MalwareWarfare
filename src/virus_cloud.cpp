#include "virus_cloud.h"

void Virus_cloud::Load(char *filename,int _id)
{
 id=_id;

 char path_to_image[TEXT_LENGTH_MAX],path_to_attack_image[TEXT_LENGTH_MAX],path_to_dying_image[TEXT_LENGTH_MAX],name[TEXT_LENGTH_MAX];
 char path_to_splash_image[TEXT_LENGTH_MAX],path_to_walking_image[TEXT_LENGTH_MAX];
 FILE *in=fopen(filename,"r");
 const int NUMBER_OF_VARS=6;
 int *vars[NUMBER_OF_VARS]={&number_of_frames,&damage,&health,&cooldown_time,&ram_reward,&spawn_delay};
 const char *vars_names[NUMBER_OF_VARS]={"number_of_frames","damage","health","cooldown_time","ram_reward","spawn_delay"};
 const int NUMBER_OF_STRINGS=6;
 char *strings[NUMBER_OF_STRINGS]={path_to_image,path_to_attack_image,path_to_dying_image,path_to_walking_image,path_to_splash_image,name};
 const char *str_names[NUMBER_OF_STRINGS]={"image","attack_image","dying_image","walking_image","splash_image","name"};
 for(int i=0;i<NUMBER_OF_VARS+NUMBER_OF_STRINGS;i++)
     {
      char var_name[TEXT_LENGTH_MAX];
      fscanf(in,"%s ",var_name);
      if(i<NUMBER_OF_VARS && strcmp(var_name,vars_names[i])==0)
         {
          fscanf(in,"%d ",vars[i]);
          continue;
         }
      if(i>=NUMBER_OF_VARS && strcmp(var_name,str_names[i-NUMBER_OF_VARS])==0)
         {
          fgets(strings[i-NUMBER_OF_VARS],TEXT_LENGTH_MAX,in);
          int sq=strlen(strings[i-NUMBER_OF_VARS]);
          if(strings[i-NUMBER_OF_VARS][sq-1]=='\n')
             strings[i-NUMBER_OF_VARS][sq-1]=NULL;
          continue;
         }
      bool found=false;
      for(int j=0;j<NUMBER_OF_VARS && !found;j++)
          {
           if(strcmp(var_name,vars_names[j])==0)
              {
               fscanf(in,"%d ",vars[i]);
               found=true;
              }
          }
      for(int j=0;j<NUMBER_OF_STRINGS && !found;j++)
          {
           if(strcmp(var_name,str_names[j]))
              {
               fgets(strings[j],TEXT_LENGTH_MAX,in);
               int sq=strlen(strings[j]);
               if(strings[j][sq-1]=='\n')
                  strings[j][sq-1]=NULL;
               continue;
              }
          }
     }
 fclose(in);

 animations[STATE_IDLE].Load(path_to_image);
 animations[STATE_ATTACKING].Load(path_to_attack_image);
 animations[STATE_DYING].Load(path_to_dying_image);
 animations[STATE_WALKING].Load(path_to_walking_image);
 menu_image.Load(path_to_splash_image);
 Create_menu_image(name);
 is_cool=true;
}

void Virus_cloud::Print(int _frame,int x,int y,int angle,int state,Texture *_screen)
{
 Apply_Rotated_Texture(animations[state].Get_image(),{_frame*3*PIXELS_PER_INGAME_UNIT,0,3*PIXELS_PER_INGAME_UNIT,PIXELS_PER_INGAME_UNIT},
                       _screen,{x-PIXELS_PER_INGAME_UNIT,y,3*PIXELS_PER_INGAME_UNIT,PIXELS_PER_INGAME_UNIT},angle);
}

bool Virus_cloud::Ready_to_spawn()
{
 if(!spawn_timer.is_started())
    return true;
 return spawn_timer.get_ticks()>spawn_delay;
}

void Virus_cloud::Start_spawn_timer()
{
 spawn_timer.start();
}
